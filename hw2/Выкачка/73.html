<!DOCTYPE html>
<html data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D" lang="ru">
<head>



<title>Пишем игру от первого лица в 2КБ на Rust / Хабр</title>














































</head>
<body>
<div data-async-called="true" data-server-rendered="true" id="app"><div class="tm-layout__wrapper"><!-- --> <div></div> <div class="tm-feature tm-feature"><!-- --></div> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><div class="tm-header__burger-nav"><button class="tm-header__button tm-header__button_burger" type="button"><svg class="tm-svg-img tm-header__icon tm-header__icon-burger" height="16" width="16"><title>Меню</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#header-burger"></use></svg></button></div> <span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_ru" href="/ru/"><svg class="tm-svg-img tm-header__icon" height="16" width="16"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <!-- --> <div class="tm-header-user-menu tm-header_user-menu"><a class="tm-header-user-menu__item tm-header-user-menu__search" href="/ru/search/"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search" height="24" width="24"><title>Поиск</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#search"></use></svg></a> <!-- --> <!-- --> <!-- --> <div class="tm-header-user-menu__item"><button class="tm-header-user-menu__toggle" data-test-id="menu-toggle-guest"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_white" height="24" width="24"><title>Профиль</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#header-user"></use></svg></button> <!-- --></div> <!-- --></div></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <!-- --> <!-- --> <div class="tm-page-width"></div> <main class="tm-layout__container"><div class="tm-page" data-async-called="true" hl="ru"><div class="tm-page-width"><!-- --> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><!-- --> <div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg class="tm-svg-img pull-down__arrow" height="24" width="24"><title>Обновить</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet tm-article-snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a class="tm-user-info__userpic" href="/ru/users/PatientZero/" title="PatientZero"><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" height="32" src="//habrastorage.org/r/w32/getpro/habr/avatars/8de/9c5/34a/8de9c534a18a6cb8693270a2b528d4c0.png" width="32"/></div></a> <span class="tm-user-info__user"><a class="tm-user-info__username" href="/ru/users/PatientZero/">
      PatientZero
      <!-- --></a> <span class="tm-article-datetime-published"><time datetime="2023-03-10T07:34:39.000Z" title="2023-03-10, 10:34">вчера в 10:34</time></span></span></span></div> <!-- --></div> <h1 class="tm-article-snippet__title tm-article-snippet__title_h1" lang="ru"><span>Пишем игру от первого лица в 2КБ на Rust</span></h1> <div class="tm-article-snippet__stats"><div class="tm-article-complexity tm-article-complexity_complexity-medium"><span class="tm-svg-icon__wrapper tm-article-complexity__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Уровень сложности</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#complexity-medium"></use></svg></span> <span class="tm-article-complexity__label">
    Средний
  </span></div> <div class="tm-article-reading-time"><span class="tm-svg-icon__wrapper tm-article-reading-time__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Время на прочтение</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#clock"></use></svg></span> <span class="tm-article-reading-time__label">
    21 мин
  </span></div> <span class="tm-icon-counter tm-data-icons__item"><svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24"><title>Количество просмотров</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#counter-views"></use></svg> <span class="tm-icon-counter__value">6.3K</span></span></div> <div class="tm-article-snippet__hubs-container"><div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a class="tm-article-snippet__hubs-item-link" href="/ru/hub/gamedev/"><span>Разработка игр</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span><span class="tm-article-snippet__hubs-item"><a class="tm-article-snippet__hubs-item-link" href="/ru/hub/algorithms/"><span>Алгоритмы</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span><span class="tm-article-snippet__hubs-item"><a class="tm-article-snippet__hubs-item-link" href="/ru/hub/maths/"><span>Математика</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span><span class="tm-article-snippet__hubs-item"><a class="tm-article-snippet__hubs-item-link" href="/ru/hub/rust/"><span>Rust</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span></div></div> <div class="tm-article-snippet__labels-container"><div class="tm-article-snippet__labels"><div class="tm-article-snippet__label tm-article-snippet__label_variant-tutorial"><span>
          Туториал
        </span></div> <div class="tm-article-snippet__label tm-article-snippet__label tm-article-snippet__label_variant-translation"><span>
          Перевод
        </span></div></div></div> <!-- --> <!-- --></div></div> <div class="tm-article-presenter__origin"><a class="tm-article-presenter__origin-link" href="https://grantshandy.github.io/posts/raycasting/" target="_blank">
                Автор оригинала:
                <span>
                  Grant Handy
                </span></a></div> <div class="tm-article-body" data-gallery-root="" lang="ru"><div></div> <div id="post-content-body"><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><div style="text-align:center;"><img data-src="https://habrastorage.org/webt/yi/b_/mk/yib_mkw7ipucd4bpgko7nc27mda.png" src="https://habrastorage.org/r/w1560/webt/yi/b_/mk/yib_mkw7ipucd4bpgko7nc27mda.png"/></div><br/>
<h2>Введение</h2><br/>
Поначалу кажется, что создать игру от первого лица без движка или графического API практические невозможно. В этом посте я расскажу, как это сделать при помощи алгоритма под названием ray casting.<br/>
<br/>
Моя цель — показать, что сложную задачу можно разбить на более простые части, и если я всё сделаю правильно, то у вас появится ощущение, что вы <em>сами открыли</em>, как работает игра.<br/>
<br/>
Для начала разберёмся, как работает алгоритм, а затем построчно напишем его. Затем мы пересмотрим код, добавим несколько возможностей и оптимизируем его размер. Я постарался сделать пост максимально доступным и дружелюбным, но вам поможет приличное знание программирования, Rust и основ геометрии.<br/>
<a name="habracut"></a><br/>
Вот краткое превью того, что мы будем делать.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6405a5509f1c6be050c3d63b" data-style="" id="6405a5509f1c6be050c3d63b" width=""></div></div><br/>
Если вы просто хотите посмотреть исходный код, то перейдите в <a href="https://github.com/grantshandy/wasm4-raycaster" rel="nofollow noopener noreferrer">репозиторий на Github</a>.<br/>
<br/>
Мои первые опыты с подобными играми (хотя в то время я об этом ещё не знал) начались в средней школе с игр наподобие <a href="https://www.ticalc.org/archives/files/fileinfo/360/36062.html" rel="nofollow noopener noreferrer">zDoom</a> на калькуляторе. zDoom (хотя и не был особо интересным) казался мне удивительным, потому что мог создавать своего рода иллюзию глубины и перспективы, на что, по моему мнению, были способны только «настоящие» игры.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/iq/h5/qi/iqh5qickmvfmohpku_l03wggnfy.png" src="https://habrastorage.org/r/w1560/webt/iq/h5/qi/iqh5qickmvfmohpku_l03wggnfy.png"/></div><br/>
zDoom был всего лишь имитацией настоящего Doom, на самом деле, он гораздо ближе к предшественнику Doom под названием Wolfenstein 3D.<br/>
<br/>
<h3>Wolfenstein 3D</h3><br/>
Знаменитая игра <a href="https://en.wikipedia.org/wiki/Wolfenstein_3D" rel="nofollow noopener noreferrer">Wolfenstein 3D</a>, выпущенная в 1992 году, была одним из первых 3D-шутеров от первого лица для потребительских ПК. В те времена у компьютеров не было аппаратного 3D-ускорения, не говоря уж об специальных графических картах, так как же игра была устроена?<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/q_/9i/sk/q_9iskwrzew09o8iaclg5_gnfpq.png" src="https://habrastorage.org/r/w1560/webt/q_/9i/sk/q_9iskwrzew09o8iaclg5_gnfpq.png"/></div><br/>
<i>Скриншот Wolfenstein 3D</i><br/>
<br/>
Ну, на самом деле нужно было сказать <a href="https://en.wikipedia.org/wiki/2.5D" rel="nofollow noopener noreferrer"><em>«псевдо</em>-3D»</a>, потому что ни одна часть игры не работала в трёх измерениях. Основой игры был алгоритм под названием ray casting (рейкастинг, метод «бросания лучей») — процесс проецирования 2D-игры в 3D-перспективу. (В этом посте я ради краткости называю термином ray casting конкретный алгоритм рейкастинга, используемый в играх наподобие Wolfenstein 3D. Это немного неточно, поскольку в области графики термин ray casting имеет более общее значение. См. <a href="https://en.wikipedia.org/wiki/Ray_casting" rel="nofollow noopener noreferrer">статью в Википедии</a>.)<br/>
<br/>
Все объекты игры располагались в простых координатах x и y карты и не могли перемещаться по вертикали. На момент выпуска игры это казалось мне неважным, однако сегодня она выглядит сильно устаревшей. Игрок не мог смотреть вверх или вниз, не мог ползать и прыгать.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/tp/lg/oz/tplgozq52k3xxyqxfeq2pogeqxe.png" src="https://habrastorage.org/r/w1560/webt/tp/lg/oz/tplgozq52k3xxyqxfeq2pogeqxe.png"/></div><br/>
<i>Вид сверху на первый уровень Wolfenstein 3D</i><br/>
<br/>
Кроме того, все уровни состояли из единственных этажей здания без окон. Все стены были идеально прямыми, а углы располагались с равномерными интервалами (что сегодня совершенно неприемлемо). Эти аспекты дизайна были использованы из-за неотъемлемых ограничений, свойственных этому простому алгоритму ray-casting.<br/>
<br/>
<h2>Алгоритм</h2><br/>
<h3>Основы</h3><br/>
На самом фундаментальном уровне ray casting основан на простом факте: удалённые от нас объекты выглядят меньше, а близкие — больше. Ray casting использует это наблюдение, отрисовывая далёкие от игрока стены с меньшей высотой, а близкие к нему — с большей.<br/>
<br/>
Даже эта простая идея создаёт убедительную иллюзию глубины и позволяет нам перемещать игрока, как будто он рендерится в реальном 3D.<br/>
<br/>
Ray casting трассирует путь от игрока до ближайшей стены для каждого столбца окна обзора игрока. Затем он записывает расстояния каждого пути и преобразует их в высоту стены и рисует её на экране в виде вертикальной линии.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/6f/zz/bk/6fzzbk3l7hhxmdonezjwdtkpb_g.png" src="https://habrastorage.org/r/w1560/webt/6f/zz/bk/6fzzbk3l7hhxmdonezjwdtkpb_g.png"/></div><br/>
Из этого описания алгоритма ray casting мы можем понять, что нам нужно делать:<br/>
<br/>
<ul>
<li>Испустить луч из игрока и остановиться на ближайшей стене</li>
<li>Вычислить расстояние от игрока до ближайшей стены</li>
<li>Преобразовать это расстояние в высоту стены и отрисовать её на экране</li>
<li>Повторять для каждого столбца экрана</li>
</ul><br/>
<h3>Углубляемся дальше</h3><br/>
Самое сложное — это пункт «испустить луч из игрока и остановиться на ближайшей стене». В теории кажется простым, но на практике это может быть <a href="https://en.wikipedia.org/wiki/Collision_detection" rel="nofollow noopener noreferrer">довольно трудно</a>. Если бы мне пришлось самостоятельно придумывать реализацию <br/>
ray casting, то как бы я подошёл к решению этой задачи?<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/bs/dv/-z/bsdv-zxvavekmtm0ihnwpam96j0.png" src="https://habrastorage.org/r/w1560/webt/bs/dv/-z/bsdv-zxvavekmtm0ihnwpam96j0.png"/></div><br/>
<i>Проблема пересечения</i><br/>
<br/>
Первым делом большинство людей, скорее всего, предложило бы многократно продлевать луч на небольшое расстояние и останавливаться, когда он столкнётся со стеной. [«Продление луча» — это не совсем точное использование понятия, вернее было бы назвать его в этой ситуации «вектором», однако «луч» звучит лучше, к тому же это слово используется в названии «ray casting».] Но это проблематично, поскольку продлевая луч, мы можем перескочить через стену. А если луч столкнётся со стеной, то это будет давать очень низкую точность, поскольку он не будет знать точно, где началась стена.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/9e/vn/bz/9evnbzcc3kq8b6lucn-96v1qeyg.png" src="https://habrastorage.org/r/w1560/webt/9e/vn/bz/9evnbzcc3kq8b6lucn-96v1qeyg.png"/></div><br/>
<i>Наивное решение</i><br/>
<br/>
Нам нужно каким-то образом <em>гарантировать</em>, что луч пересечётся со стеной и остановится ровно на границе стены. В мире математики это можно было бы сделать, продлевая луч на бесконечно малое расстояние бесконечно много раз. К сожалению, мы находимся не в мире математики и не можем этого сделать.<br/>
<br/>
Решением этой проблемы, как можно было понять из предыдущего описания, станет привязка всех стен к сетке. Если мы знаем, что стены встречаются с предсказуемыми интервалами, то можно каждый раз вычислять надёжное расстояние, на которое нужно продлевать луч.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/6f/yk/jk/6fykjkwexdf-sjrlqdjnr5kzvbm.png" src="https://habrastorage.org/r/w1560/webt/6f/yk/jk/6fykjkwexdf-sjrlqdjnr5kzvbm.png"/></div><br/>
<i>Заметили паттерн?</i><br/>
<br/>
Но как луч доскочит до стены?<br/>
<br/>
Если взять бумагу в клетку и начать рисовать линии между игроком и разными стенами, то вы заметите определённые паттерны. «Продления» лучей до стен на горизонтальных линиях сетки имеют общую ширину, а «продления» лучей, попадающие на стены на вертикальных линиях сетки, имеют одинаковую высоту.<br/>
<br/>
Продлив луч до первой линии сетки, мы можем вычислить эти общие «ширины продлений» и «высоты продлений». Затем мы многократно будем продлевать луч на эти ширины и высоты, чтобы получить первую «вертикальную стену» и «горизонтальную стену», и используем меньшее из двух расстояний.<br/>
<br/>
Наверно, это всё слишком сложно, поэтому объясню чуть подробнее.<br/>
<br/>
<h3>Горизонтальные пересечения</h3><br/>
Вот пример того, что происходит, когда игрок смотрит на «горизонтальную стену». [В оригинале статьи схема интерактивна.]<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/xc/-m/gl/xc-mglbugvlru5v-zwwm9xl-ooo.png" src="https://habrastorage.org/r/w1560/webt/xc/-m/gl/xc-mglbugvlru5v-zwwm9xl-ooo.png"/></div><br/>
<i>При перемещениях игрока меняется только <em>ширина</em> между продлениями луча.</i><br/>
<br/>
Во взаимодействиях с горизонтальными стенами высота между «продлениями» всегда равна единице, а ширину между «продлениями» можно вычислить по углу луча. Он всегда движется вверх или вниз ровно на единицу и вправо или влево на величину, определяемую углом луча.<br/>
<br/>
Это видно по схеме: ширина между <img alt="$A_x$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/3c6/1a8/afd/3c61a8afd0369760f62701ac610b86ad.svg"/> и <img alt="$B_x$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/3b3/4ca/089/3b34ca08995ef4f4425b15f9c143c7bb.svg"/> такая же, как ширина между <img alt="$B_x$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/3b3/4ca/089/3b34ca08995ef4f4425b15f9c143c7bb.svg"/> и <img alt="$C_x$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/b6b/14b/712/b6b14b712a231b64a48159514a5c799b.svg"/>, а разность высот между всеми точками всегда равна единице.<br/>
<br/>
При помощи простой тригонометрии мы можем найти ширину между горизонтальными пересечениями сетки из угла игрока. Я сэкономлю вам время и просто дам формулу<br/>
<br/>
<p></p><p><img alt="$ \Delta H = \begin{cases} 1 &amp;\text{если “смотрит вверх”} \\ -1 &amp;\text{если “смотрит вниз”} \end{cases}$" data-tex="display" src="https://habrastorage.org/getpro/habr/formulas/28d/510/e7a/28d510e7a8164c65965c94a87274b49b.svg"/></p><br/>
<p></p><p><img alt="$\Delta W = \frac{\Delta H}{\tan(\theta)}$" data-tex="display" src="https://habrastorage.org/getpro/habr/formulas/b13/1b4/78b/b131b478b2e0cfe89e753410a0e440ff.svg"/></p><br/>
<h3>Вертикальные пересечения</h3><br/>
Вот ещё одна схема (в оригинале статьи интерактивная) пересечения луча с «вертикальной стеной».<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/mt/wm/a6/mtwma6irovglzyo0l19ecuwajao.png" src="https://habrastorage.org/r/w1560/webt/mt/wm/a6/mtwma6irovglzyo0l19ecuwajao.png"/></div><br/>
<i>Здесь <em>высота</em> между продлениями меняется, а ширина остаётся той же</i><br/>
<br/>
Вертикальные пересечения сетки такие же, как и горизонтальные, только повёрнутые на 90°. В вертикальных пересечениях <em>ширина</em> между «продлениями луча» постоянна, а <em>высота</em> воссоздаётся по углу луча. Как и ранее, я пропущу вывод и покажу только формулы.<br/>
<br/>
<p></p><p><img alt="$\Delta W = \begin{cases} 1 &amp;\text{если “смотрит вправо”} \\ -1 &amp;\text{если “смотрит влево”} \end{cases}$" data-tex="display" src="https://habrastorage.org/getpro/habr/formulas/64e/462/292/64e462292e45b8e15b94b082ce4db062.svg"/></p><br/>
<p></p><p><img alt="$\Delta H = \Delta W * \tan(\theta)$" data-tex="display" src="https://habrastorage.org/getpro/habr/formulas/1d3/467/611/1d34676115afa3fd9a519fd056db2d10.svg"/></p><br/>
<h3>Подведём итог</h3><br/>
Теперь, когда мы достаточно чётко знаем, как это сделать, превратим это в более подробный поэтапный список, который наша программа будет выполнять в каждом кадре.<br/>
<br/>
Для каждого столбца на экране:<br/>
<br/>
<ol>
<li>Найти угол для луча из угла игрока и поля его зрения.</li>
<li>Определить расстояние до ближайшей стены, с которой пересекается луч:<ul>
<li>Получить первую «горизонтальную» стену, с которой пересекается луч.</li>
<li>Получить первую «вертикальную» стену, с которой пересекается луч.</li>
<li>Вычислить расстояние до ближайшей из этих двух стен.</li>
</ul></li>
<li>Преобразовать это расстояние в высоту стены на экране, а затем отрисовать её.</li>
</ol><br/>
<h2>Реализация</h2><br/>
Теперь, когда мы знаем, как внутри устроен алгоритм, можно написать программу, которая реализует его с использованием WASM-4.<br/>
<br/>
Постойте, а почему WASM-4? Официальный ответ: потому что наша программа должна как-то принимать пользовательский ввод и выполнять отрисовку на экране. Реальный ответ: он мне сильно нравится.<br/>
<br/>
<a href="https://wasm4.org" rel="nofollow noopener noreferrer">WASM-4</a> — это крошечный игровой движок, выполняющий файлы WebAssembly (). Большинство компилируемых языков программирования (C, C++, Rust, Zig и так далее) можно компилировать в WebAssembly, то есть игры для WASM-4 можно писать на любом из этих языков! WASM-4 <em>чрезвычайно</em> минималистичен, «4» в названии WASM-4 означает, что на экране можно одновременно отрисовывать только четыре цвета.<br/>
<br/>
Я воспользуюсь Rust, а вы можете писать игру на любом языке, который компилируется в WebAssembly. Если вам ближе JavaScript, то рекомендую <a href="https://assemblyscript.org" rel="nofollow noopener noreferrer">AssemblyScript</a>.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/8d/-b/4u/8d-b4ufxoyunemwvwvrklmgaimw.png" src="https://habrastorage.org/r/w1560/webt/8d/-b/4u/8d-b4ufxoyunemwvwvrklmgaimw.png"/></div><br/>
WASM-4 позволит нам создавать <em>крошечные</em> игры, потому что предоставляет для творчества простую платформу. WASM-4 занимается работой с окнами, рендерингом графики и вводом с геймпада, а всё остальное предстоит сделать нам.<br/>
<br/>
Вот спецификации «вымышленной консоли» WASM-4 с её сайта:<br/>
<br/>
<blockquote><ul>
<li>Экран: 160x160 пикселей, 4 настраиваемых цвета, обновляется с частотой 60 Гц.</li>
<li>Память: 64 КБ линейной ОЗУ, ввод-вывод с отображением в память, сохранение состояний.</li>
<li>Максимальный размер картриджа: 64 КБ.</li>
<li>Ввод: клавиатура, мышь, сенсорный экран, до четырёх геймпадов.</li>
<li>Звук: 2 канала импульсных волн, 1 канал треугольных волн, 1 канал шума.</li>
<li>Дисковый накопитель: 1024 байта.</li>
</ul></blockquote><br/>
Если вы немного разбираетесь в компьютерном «железе», то понимаете, насколько <em>невероятно</em> жёсткие это ограничения для игры. Однако мне было интересно увидеть, сколько всего можно уместить в 160x160 пикселей, 4 цвета и 64 КБ на диске. Если вам любопытно, что с такими ограничениями способны делать люди, зайдите на <a href="https://wasm4.org/play" rel="nofollow noopener noreferrer">сайт WASM-4</a>, там есть впечатляющие игры (в том числе и лётный симулятор!).<br/>
<br/>
Вероятно, в будущем я напишу более подробный пост о WASM-4, но пока такого объяснения будет достаточно. Для запуска игр на WASM-4 достаточно <a href="https://wasm4.org/docs/getting-started/setup" rel="nofollow noopener noreferrer">скачать и установить минимальную среду исполнения</a>.<br/>
<br/>
<h3>Подготовка проекта</h3><br/>
Так как WASM-4 выполняет файлы WebAssembly, нам нужно сконфигурировать проект, чтобы создать такой файл.<br/>
<br/>
<pre></pre><br/>
Добавим это в :<br/>
<br/>
<pre></pre><br/>
Мы можем сообщить cargo, что хотим создать динамическую библиотеку в стиле C () и оптимизировать двоичный файл для минимизации размера. Также импортируем библиотеку <a href="https://crates.io/crates/libm" rel="nofollow noopener noreferrer"></a>, которая предоставит нам -реализации нужных нам функций наподобие ,  и  (подробнее об этом позже).<br/>
<br/>
В файл конфигурации крейта  добавим следующее:<br/>
<br/>
<pre></pre><br/>
Это прикажет cargo по умолчанию использовать WebAssembly и передать rustc флаги, приказывающие программе зарезервировать для игры память.<br/>
<br/>
Теперь давайте добавим в файл исходников  простой бойлерплейт:<br/>
<br/>
<pre></pre><br/>
Вот небольшое объяснение кода для тех, кто не знаком с Rust или WASM-4:<br/>
<br/>
<ul>
<li> запрещает программе выполнять доступ к стандартной библиотеке Rust. Это необходимо почти для всех игр на WASM-4, поскольку стандартная библиотека велика, из-за чего наша игра может занять больше 64 КБ.</li>
<li><a href="https://wasm4.org/docs/reference/memory#gamepads" rel="nofollow noopener noreferrer"></a> — это указатель на текущее состояние первого геймпада (в нашем случае на клавиши со стрелками). Среда исполнения в каждом кадре будет записывать в эту область памяти состояние геймпада (клавиатуры).</li>
<li>Константы с  по  описывают биты геймпада, описывающие каждую кнопку. Можно использовать их для проверки того, сообщает ли  о нажатии кнопки; именно это мы будем делать, вызывая .</li>
<li> привязывает нашу игру к внешней функции <a href="https://wasm4.org/docs/reference/functions/#vlinex-y-len" rel="nofollow noopener noreferrer"></a>, предоставляемой нам движком WASM-4.<br/>
 отрисовывает вертикальную линию в окне по координатам ,  и протягивает её вниз на  пикселей.</li>
<li> — это небольшой фрагмент бойлерплейта, который должен реализовать Rust, если мы решаем использовать . Эта функция будет выполняться при панике программы. Так как WASM-4 — настолько жёстко ограниченная среда, единственное, что мы можем сделать — это вызвать .</li>
<li><a href="https://wasm4.org/docs/reference/functions/#update-" rel="nofollow noopener noreferrer"></a> — это основная точка входа нашей программы, WASM-4 вызывает эту функцию в каждом кадре.</li>
</ul><br/>
Для компиляции игры мы можем собрать её, как любой другой крейт:<br/>
<br/>
<pre></pre><br/>
А для её запуска можно использовать :<br/>
<br/>
<pre></pre><br/>
Запустится пустое окно, и, если мы нажмём на стрелку вверх на клавиатуре, появится вертикальная линия в палитре Gameboy.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/p2/vm/4d/p2vm4dq8vxpynzegb0fmjfekcg4.png" src="https://habrastorage.org/r/w1560/webt/p2/vm/4d/p2vm4dq8vxpynzegb0fmjfekcg4.png"/></div><br/>
Получилось!<br/>
<br/>
В ситуациях с подобными командами, которые мы будем вызывать часто, я люблю помещать их в простой Makefile, чтобы нам не пришлось вводить команды заново или слишком часто использовать стрелку вверх. После этого для сборки и запуска программы остаётся ввести .<br/>
<br/>
<pre></pre><br/>
Отлично, рабочий процесс готов, мы можем приступать к написанию игры.<br/>
<br/>
<h3>Хранение карты</h3><br/>
Проще всего хранить карту в сетке, состоящей из стен и «не-стен». Один из способов заключается в сохранении карты в виде  и в выполнении доступа к ней при помощи . Подобное хранение карты не будет особо изящным решением, потому что нам придётся вводить каждую ячейку по отдельности как  или .<br/>
<br/>
Так как булево значение (стена и «не-стена») можно представить одним битом, для описания карты можно использовать биты внутри числа: . В таком случае  может обозначать карту шириной 16 ячеек и произвольной выбранной нами высоты. При помощи синтаксиса целочисленных литералов Rust мы можем достаточно просто представить нашу карту, записывая  там, где должна быть стена, и , не должна быть «не-стена»:<br/>
<br/>
<pre></pre><br/>
При таком способе хранения карты к ней сложнее получать доступ. Для этого нужно написать функцию, которая сначала индексирует строку в конкретный столбец при помощи маскирования, а затем сдвигает строку. Пост и так получился длинным, так что ради экономии времени я не буду вдаваться в подробности о том, как в этой функции работают битовые операции поиска координаты X.<br/>
<br/>
<pre></pre><br/>
Так как наша карта окружена стенами, то, если вызывающий эту функцию передаёт координату вне пределов карты, можно безопасно сообщить, что стена есть.<br/>
<br/>
<blockquote>Стоит также заметить, что в  ось Y «перевёрнута», то есть <img alt="$y = 0$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/423/f33/c68/423f33c68c9d7ff01925569297938a28.svg"/> находится наверху. Это не только быстрее, но и отражает <a href="http://www.e-cartouche.ch/content_reg/cartouche/graphics/en/html/Screen_learningObject3.html" rel="nofollow noopener noreferrer">систему координат, которая чаще всего используется в ПО</a>.</blockquote><br/>
<h3>Хранение состояния игры</h3><br/>
Во время выполнения программы карта остаётся неизменной, меняются позиция и угол игрока. Так как WASM-4 вызывает  в каждом кадре, единственный способ хранения состояния игры между кадрами — это что-то типа <a href="https://doc.rust-lang.org/reference/items/static-items.html" rel="nofollow noopener noreferrer"></a> языка Rust. Так как  является <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html" rel="nofollow noopener noreferrer"></a>, нам нужно объединить логику игры и состояние в единую , чтобы минимизировать количество случаев модификации состояния через .<br/>
<br/>
Для описания окна просмотра игрока достаточно всего трёх переменных: позиций X и Y, а также угла обзора.<br/>
<br/>
<pre></pre><br/>
Теперь поместим  в :<br/>
<br/>
<pre></pre><br/>
<blockquote><em>Изначально и , и  имеют значение 1.5, чтобы игрок всегда начинал с центра ячейки, а не внутри стены.</em></blockquote><br/>
-поведением является не только доступ к , но и большинство взаимодействий с WASM-4 (разыменование сырых указателей, вызов внешних функций и так далее).<br/>
<br/>
Для незнакомых с Rust скажу, что  — это ключевое слово/блок, который мы передаём компилятору, когда нам нужно обойти гарантии безопасности памяти. Использование  говорит компилятору Rust: «Я знаю, что делаю, не надоедай мне с этим». Проблема в том, что часто мы не знаем, что делаем. Из-за этого стоит использовать  по минимуму.<br/>
<br/>
Если мы объединим -поведение в , а игровую логику в , то изолируем состояние и придадим программе структуру. Это даёт нам достаточно чёткую линию:  (небезопасный) ввод-вывод при помощи WASM-4 в , безопасная игровая логика в .<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/xf/nz/3l/xfnz3lt876x0lnw_htceaqjq51o.png" src="https://habrastorage.org/r/w1560/webt/xf/nz/3l/xfnz3lt876x0lnw_htceaqjq51o.png"/></div><br/>
<h3>Перемещение персонажа</h3><br/>
Одна из простейших частей этой игры — перемещение персонажа. Так как доступ к  снаружи является , давайте создадим внутри  метод для перемещения персонажа и в каждом кадре будем передавать ему ввод.<br/>
<br/>
<pre></pre><br/>
Если вы когда-нибудь перемещали персонажа в игре и знаете основы тригонометрии, то код покажется вам знакомым. Обратите внимание, что вызовы  отрицательны, потому что ось Y перевёрнута.<br/>
<br/>
Если игрок просит нас переместить персонажа вперёд или назад, мы изменяем позиции x и y на основании значений  и , умноженных на константу .<br/>
<br/>
Только для вас я укажу волшебное число, которое здесь неплохо подходит. При желании вы сможете его изменить:<br/>
<br/>
<pre></pre><br/>
Последнее, что нужно сделать для работы этой функции — импортировать  и  из .<br/>
<br/>
<pre></pre><br/>
<blockquote><em>Почему , а не ? Этот принцип именования взят из libm языка C, где  работают с double, а  — с float. В реализации  языка Rust это значит  и . Мы используем , а не , потому что это экономит место и нам не нужна такая точность.</em></blockquote><br/>
Последнее, что нам нужно сделать — разумеется, вызвать новый !<br/>
<br/>
<h3>Горизонтальные пересечения</h3><br/>
Прежде чем отрисовать стены на экране, нужно реализовать ядро нашего алгоритма: проверки горизонтальных и вертикальных пересечений.<br/>
<br/>
Сначала нужно расширить предыдущий оператор импорта :<br/>
<br/>
<pre></pre><br/>
При помощи  мы можем создать функцию расстояния <img alt="$D = \sqrt{(\Delta X^2)+(\Delta Y^2)}$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/861/cbc/c5e/861cbcc5e5ac0499755dab9fec37a077.svg"/>:<br/>
<br/>
<pre></pre><br/>
Далее импортируем полезные константы основной библиотеки для <img alt="$\pi$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/4a2/2d7/df5/4a22d7df5480ab752635de38c7fd774e.svg"/> и <img alt="$\frac{\pi}{2}$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/5b0/72c/e38/5b072ce38a3b984cab1e14a6fc84ebf1.svg"/>:<br/>
<br/>
<pre></pre><br/>
Так как нам нужно получать доступ к углу и позиции игрока, давайте создадим внутри  метод . Это будет самая сложная функция из тех, которые мы писали, но, по сути, она отражает уже описанный мной алгоритм, так что в этом случае я оставлю свои комментарии <em>внутри</em> кода.<br/>
<br/>
<pre></pre><br/>
<h3>Вертикальные пересечения</h3><br/>
Давайте перед отрисовкой стен также реализуем вертикальные пересечения.<br/>
<br/>
Вы заметите, что эта функция практически идентична предыдущей. Давайте добавим внутрь  метод , аналогичный :<br/>
<br/>
<pre></pre><br/>
<h3>Получаем окно просмотра</h3><br/>
Пока мы не написали ничего, с чем можно было бы взаимодействовать. Точнее, мы можем <em>действовать</em> (перемещать персонажа), но не увидим, как это происходит. Давайте попробуем отрисовывать стены.<br/>
<br/>
Как говорилось в разделе «Подведём итог», нам нужно рисовать вертикальные линии для каждого столбца в окне.<br/>
<br/>
Можно разделить это на две отдельные задачи: получение высот линий и отрисовка их на экране. Почему не делать всё одновременно? Потому что  является , поэтому нужно оставить её в .<br/>
<br/>
Давайте сделаем это, определив , возвращающий список всех высот стен. Тогда в каждом кадре мы сможем вызывать  из  и отрисовывать все эти вертикальные линии, которые мы только что вычислили.<br/>
<br/>
<pre></pre><br/>
 будет обходить каждую вертикальную линию на экране (все 160), вычисляя угловое смещение с точки зрения игрока, а затем находя расстояние до ближайшего горизонтального и вертикального пересечения со стенами на пути луча. Затем он сравнивает два расстояния и превращает меньшее из них в высоту стены.<br/>
<br/>
Знаю, это звучит сложно, поэтому давайте запишем, как это выглядит.<br/>
<br/>
Сначала создадим несколько констант, определяющих перспективу игрока:<br/>
<br/>
<pre></pre><br/>
<blockquote> — это высота в пикселях стены, <br/>
 находящейся на расстоянии одной единицы от игрока.</blockquote><br/>
Теперь давайте добавим в блок impl  функцию :<br/>
<br/>
<pre></pre><br/>
Выглядит неплохо, попробуем запустить! Игрока можно перемещать клавишами со стрелками на клавиатуре.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6408d4003afabae066738c26" data-style="" id="6408d4003afabae066738c26" width=""></div></div><br/>
Отлично, нам удалось создать иллюзию глубины! Для первой попытки впечатляющий результат. Большинство туториалов на этом останавливаются, однако есть некоторые проблемы, которые нам нужно решить.<br/>
<br/>
<h2>Исправление перспективы</h2><br/>
При перемещении вы можете заметить, что всё выглядит… не совсем правильно. Стены изгибаются, как будто мы смотрим через объектив «рыбий глаз».<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/rj/sc/wz/rjscwztlazjxdz03csm-84c1ybs.png" src="https://habrastorage.org/r/w1560/webt/rj/sc/wz/rjscwztlazjxdz03csm-84c1ybs.png"/></div><br/>
Это вызвано тем, что наш алгоритм ошибочно предполагает, что зрение человека сходится к одной бесконечно малой точке (игроку). В реальной жизни зрительная кора головного мозга постоянно смешивает точки зрения из обоих глаз, создавая глубину.<br/>
<br/>
В данном случае гораздо более точной метафорой будет плоскость, перпендикулярная перспективе, испускающей лучи:<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/ct/fp/tg/ctfptgj6hobychi-zsshjmwyqme.png" src="https://habrastorage.org/r/w1560/webt/ct/fp/tg/ctfptgj6hobychi-zsshjmwyqme.png"/></div><br/>
Разумеется, описание довольно расплывчатое, но оно станет понятнее, если воспринимать это как «коррекцию рыбьего глаза». Чтобы применить эту «коррекцию», нужно умножить расстояние на косинус разности между углом луча и углом игрока:<br/>
<br/>
<p></p><p><img alt="$H= \frac{C}{D \times \cos(\Delta \theta)}$" data-tex="display" src="https://habrastorage.org/getpro/habr/formulas/f20/9b5/149/f209b51490e87bc430125a2e814b28c3.svg"/></p><br/>
Где <img alt="$H$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/26d/143/6f5/26d1436f51b75e0df6df1d8f1eb322ec.svg"/> — высота стены в пикселях, <img alt="$D$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/2e2/3b0/ca7/2e23b0ca7b48e0096c7d8eb2d3c3d0ca.svg"/> — это расстояние до стены, <img alt="$\Delta\theta$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/a12/2a5/39f/a122a539fa609d0461259cdaf5684216.svg"/> — разность между углом луча и углом игрока.<br/>
<br/>
Чтобы применить эту корректировку, нам достаточно изменить единственную строку в функции :<br/>
<br/>
<pre></pre><br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/s4/1-/fm/s41-fmpgeqghlijmewruyou-c6k.png" src="https://habrastorage.org/r/w1560/webt/s4/1-/fm/s41-fmpgeqghlijmewruyou-c6k.png"/></div><br/>
Отлично! Теперь стены прямые.<br/>
<br/>
<h2>Добавление глубины</h2><br/>
В текущей версии игры сложно различить разные стены. Особенно на расстоянии: стены сливаются друг с другом и сложно отличить их друг от друга.<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/w6/in/au/w6inau4ssgygdylnw0xffoftg-u.png" src="https://habrastorage.org/r/w1560/webt/w6/in/au/w6inau4ssgygdylnw0xffoftg-u.png"/></div><br/>
В реальной жизни мы можем различать стены по их теням. Можно попробовать эмулировать это в игре, по-разному раскрашивая стены в зависимости от их ориентации. К счастью, мы уже знаем, какие стены «смотрят на восток/запад», а какие «на север/юг» благодаря тому, какие лучи пересекаются с ними! Зная это, довольно легко назначить стенам разные цвета.<br/>
<br/>
WASM-4 использует уникальный способ задания цвета, который функции применяют для отрисовки. При каждом вызове функции отрисовки в WASM-4 он решает, какой цвет использовать, на основании индекса, хранящегося в бите памяти, называемого . В WASM-4 легко менять , это делается при помощи простой шестнадцатеричной записи.<br/>
<br/>
Давайте добавим  рядом с  в начале файла:<br/>
<br/>
<pre></pre><br/>
Теперь мы можем переписать  так, чтобы она передавала, должна ли стена отрисовываться «с тенью» или нет:<br/>
<br/>
<pre></pre><br/>
Теперь давайте внесём в fn update следующие изменения:<br/>
<br/>
<pre></pre><br/>
Давайте попробуем запустить:<br/>
<br/>
<div style="text-align:center;"><img data-src="https://habrastorage.org/webt/xf/nt/rv/xfntrvexvr2oizl2l1gic9uxlra.png" src="https://habrastorage.org/r/w1560/webt/xf/nt/rv/xfntrvexvr2oizl2l1gic9uxlra.png"/></div><br/>
Ого, выглядит намного лучше. Даже несмотря на то, что тени в реальном мире так себя не ведут, это добавляет хорошие детали и помогает создать иллюзию глубины.<br/>
<br/>
<h2>Уменьшаем программу!</h2><br/>
Если вы сейчас проверите размер программы, допустим, вызвав , то можете получить нечто подобное:<br/>
<br/>
<pre></pre><br/>
Это гораздо больше, чем исполняемый файл в 2 КБ, который я обещал в заголовке, так как же нам его добиться? Один из способов уменьшения размера файлов  — применение . Обычно получить  можно, установив пакет <a href="https://pkgs.org/download/binaryen" rel="nofollow noopener noreferrer"></a>.  специально разработан для оптимизации файлов  устранением мёртвого кода и дублирующихся команд, которые оставляет компилятор.<br/>
<br/>
Давайте добавим в наш  этап  step in our  и заодно сделаем так, чтобы он сообщал, каков размер файла :<br/>
<br/>
<pre></pre><br/>
<pre></pre><br/>
Хм, недостаточно.<br/>
<br/>
<h2>Ещё меньше?!</h2><br/>
Если вы заглянете в исполняемый файл, то скорее всего увидите, что основная часть пространства занята функциями, которые мы импортировали из . Последний шаг требует полного устранения  и её замены собственной реализацией.<br/>
<br/>
Давайте начнём с удаления оператора импорта  и устранения его из . После этого можно добавить аппроксимацию функции  при помощи <a href="https://en.wikipedia.org/wiki/Bhaskara_I%27s_sine_approximation_formula" rel="nofollow noopener noreferrer">аппроксимации синуса Бхаскары I</a> и переопределения  и  с её учётом.<br/>
<br/>
<p></p><p><img alt="$\sin(x) \approx \frac{16x(\pi-x)}{5\pi^2-4x(\pi-x)} \text{ when } (0 \le x \le \pi)$" data-tex="display" src="https://habrastorage.org/getpro/habr/formulas/82a/534/c52/82a534c52dc6bef65c36650446b368d2.svg"/></p><br/>
Эта аппроксимация <em>чрезвычайно</em> хороша, особенно с учётом времени её вывода. А поскольку мы работаем с высотами стен, изменяющихся в интервале целых чисел от 0 до 160, любые различия между  и нашим  будут незаметны.<br/>
<br/>
Сначала импортируем <img alt="$\tau$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/7f9/e85/1fc/7f9e851fcce04167d29cc3158936ebd6.svg"/> из основной библиотеки и определим константу для <img alt="$5\pi^2$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/ba7/f5e/d94/ba7f5ed94a8611b26837765d635c9b42.svg"/>, которая используется в аппроксимации Бхаскары I:<br/>
<br/>
<pre></pre><br/>
Далее добавим наш новый :<br/>
<br/>
<pre></pre><br/>
Теперь мы можем создать  и  из определений, связанных с : <img alt="$\cos(x) = \sin(x + \frac{\pi}{2})$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/3fa/768/d9b/3fa768d9ba5ba4a08fe83df48d2a3cee.svg"/><br/>
<br/>
<pre></pre><br/>
<img alt="$\tan(x) = \frac{\sin(x)}{\cos(x)}$" data-tex="inline" src="https://habrastorage.org/getpro/habr/formulas/0b9/b90/1f1/0b9b901f1930050742a53cc2ca6faf7c.svg"/><br/>
<br/>
<pre></pre><br/>
Отлично, мы заменили тригонометрические функции , а как насчёт , , , и ? И здесь в дело вступает <em>ночной</em> Rust, поэтому выполните  или с этого момента собирайте проект с nightly-фичами.<br/>
<br/>
Ночная сборка Rust позволяет нам использовать экспериментальный модуль основной библиотеки под названием .  предоставляет функции, которые компилятор знает как оптимизировать, поэтому нам не придётся их писать самим. Чтобы включить экспериментальную фичу intrinsics, добавим в начало файла :<br/>
<br/>
<pre></pre><br/>
Теперь мы можем создать несколько «безопасных» обёрток поверх unsafe-функций, которые предоставляет нам :<br/>
<br/>
<pre></pre><br/>
Скомпилируем код и просмотрим, сработало ли…<br/>
<br/>
<pre></pre><br/>
<h2>Заключение</h2><br/>
1,7 КБ — не наименьший размер этой программы, которого можно добиться. Её можно уместить в ещё меньшее пространство, и я призываю вас попробовать это сделать! Некоторые части кода я намеренно сделал более читаемыми ценой увеличения количества команд, чтобы <em>вы</em> смогли их оптимизировать.<br/>
<br/>
Я написал этот пост, потому что когда в первый раз создавал свою игру с рейкастингом, не смог найти ресурсов, объясняющих, как работает алгоритм в красивом коде и понятным языком.<br/>
<br/>
Надеюсь, он был интересным и полезным для вас! Рейкастинг в FPS всегда был для меня загадкой, пока я не начал в нём разбираться; надеюсь, вы тоже считаете лежащий в его основе алгоритм удивительно изящным.</div></div></div> <!-- --> <!-- --></div> <!-- --> <!-- --></div> <!-- --> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bwolfenstein%203d%5D">wolfenstein 3d</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%80%D0%B5%D0%B9%D0%BA%D0%B0%D1%81%D1%82%D0%B8%D0%BD%D0%B3%5D">рейкастинг</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Braycasting%5D">raycasting</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bwebassembly%5D">webassembly</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hub/gamedev/">Разработка игр</a></li><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hub/algorithms/">Алгоритмы</a></li><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hub/maths/">Математика</a></li><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hub/rust/">Rust</a></li></ul></div></div></article></div> <!-- --></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon tm-votes-meter__icon_appearance-article" height="24" width="24"><title>Всего голосов 57: ↑56 и ↓1</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#counter-rating"></use></svg> <span class="tm-votes-meter__value tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating" title="Всего голосов 57: ↑56 и ↓1">+55</span></div> <div class="v-portal" style="display:none;"></div></div> <!-- --> <!-- --> <button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button"><span class="tm-svg-icon__wrapper bookmarks-button__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#counter-favorite"></use></svg></span> <span class="bookmarks-button__counter" title="Количество пользователей, добавивших публикацию в закладки">
    80
  </span></button> <div class="tm-sharing tm-data-icons__item" title="Поделиться"><button class="tm-sharing__button" type="button"><svg class="tm-sharing__icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z" fill="currentColor"></path></svg></button> <div class="v-portal" style="display:none;"></div></div> <div class="tm-article-comments-counter-link tm-data-icons__item" title="Читать комментарии"><a class="tm-article-comments-counter-link__link" href="/ru/post/720672/comments/"><svg class="tm-svg-img tm-article-comments-counter-link__icon" height="24" width="24"><title>Комментарии</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      6
    </span></a> <!-- --></div> <!-- --> <div class="v-portal" style="display:none;"></div></div></div></div> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!-- --> <div></div> <section class="tm-block tm-block tm-block_spacing-bottom"><!-- --> <div class="tm-block__body tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a class="tm-user-card__userpic tm-user-card__userpic_size-40" href="/ru/users/PatientZero/"><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" src="//habrastorage.org/getpro/habr/avatars/8de/9c5/34a/8de9c534a18a6cb8693270a2b528d4c0.png"/></div></a> <div class="tm-user-card__meta"><div class="tm-counter-container tm-karma tm-karma" title=" 1727 голосов "><div class="tm-counter-container__header"><div class="tm-karma__votes tm-karma__votes_positive">
      1571
    </div></div> <div class="tm-counter-container__footer"><div class="tm-karma__text">
      Карма
    </div> <div class="v-portal" style="display:none;"></div></div></div> <div class="tm-counter-container" title="Рейтинг пользователя"><div class="tm-counter-container__header"> <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating"><!-- --> <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-rating"><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_rating">
        157.9
      </span></div> <!-- --></div></div> <div class="tm-counter-container__footer"><span class="tm-rating__text tm-rating__text">
      Рейтинг
    </span></div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title tm-user-card__title_variant-article"><!-- --> <a class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article" href="/ru/users/PatientZero/">
          @PatientZero
        </a> <!-- --></div> <p class="tm-user-card__short-info tm-user-card__short-info tm-user-card__short-info_variant-article">Переводчик-фрилансер</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons tm-user-card__buttons_variant-article"><!-- --> <!-- --> <button class="tm-user-card__button btn btn_transparent btn_small" type="submit">
      Задонатить
    </button> <!-- --> <!-- --></div></div> <!-- --></div> <div class="v-portal" style="display:none;"></div></div> <!-- --></section> <div class="tm-adfox-banner__container tm-page-article__banner"><!-- --> <div class="tm-adfox-banner tm-adfox-banner tm-adfox-banner_variant-leaderboard" id="adfox_164725660339535756"></div></div> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" href="/ru/post/720672/comments/"><svg class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted" height="24" width="24"><title>Комментарии</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 6 
    </span></a> <!-- --></div></div></div> <section class="tm-block tm-block tm-block_spacing-bottom"><header class="tm-block__header tm-block__header tm-block__header_variant-borderless"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2> </div> <!-- --></header> <div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim"><div class="tm-tabs tm-tabs"><div><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim">
        Лучшие за сутки
      </button></span><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link tm-tabs__tab-link_slim">
        Похожие
      </button></span></div> <!-- --></div> <div class="similar-and-daily__tab-view"><div><!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <div class="tm-placeholder-article-cards"><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div></div> <!-- --> <!-- --> <!-- --> <!-- --></div> <!-- --></div></div> <!-- --></section> <section class="tm-block tm-stories-block tm-block tm-block_spacing-around" data-async-called="true" data-navigatable="" tabindex="0"><header class="tm-block__header tm-block__header"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title">Истории</h2> </div> <!-- --></header> <div class="tm-block__body tm-block__body tm-block__body_variant-equal"><div class="tm-stories-empty"><div class="tm-stories-card-empty"><div class="tm-stories-card-empty__image"></div> <div class="tm-stories-card-empty__title"><div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div></div></div><div class="tm-stories-card-empty"><div class="tm-stories-card-empty__image"></div> <div class="tm-stories-card-empty__title"><div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div></div></div><div class="tm-stories-card-empty"><div class="tm-stories-card-empty__image"></div> <div class="tm-stories-card-empty__title"><div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div></div></div><div class="tm-stories-card-empty"><div class="tm-stories-card-empty__image"></div> <div class="tm-stories-card-empty__title"><div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div></div></div><div class="tm-stories-card-empty"><div class="tm-stories-card-empty__image"></div> <div class="tm-stories-card-empty__title"><div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div></div></div><div class="tm-stories-card-empty"><div class="tm-stories-card-empty__image"></div> <div class="tm-stories-card-empty__title"><div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div> <div class="tm-stories-card-empty__title-block"></div></div></div></div> <!-- --></div> <!-- --></section> <div><div><!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <div class="tm-placeholder-inset tm-placeholder-salary"><div class="tm-placeholder-inset__header"><div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div></div> <div class="tm-placeholder-salary__body"><div class="tm-placeholder-salary__text"><div class="tm-placeholder__line tm-placeholder__line_salary_average"></div> <div class="tm-placeholder-salary__description"><div class="tm-placeholder__line loads"></div> <div class="tm-placeholder__line loads"></div> <div class="tm-placeholder__line loads"></div> <div class="tm-placeholder__line loads"></div></div></div> <div class="tm-placeholder-salary__image loads"></div></div> <div class="tm-placeholder-inset__footer tm-placeholder-inset__footer_salary"><div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div></div></div> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --></div></div> <!-- --> <div><div><!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <div class="tm-placeholder-promo"><div class="tm-placeholder-promo__header"><div class="tm-placeholder__line tm-placeholder__line_promo-title"></div></div> <div class="tm-placeholder-promo__body"><div class="tm-placeholder-promo__posts"><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div> <div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div> <div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div> <div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div> <div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div> <div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div></div> <div class="tm-placeholder-promo__dots"><div class="tm-placeholder-promo__dot"></div> <div class="tm-placeholder-promo__dot"></div> <div class="tm-placeholder-promo__dot"></div></div></div></div> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --></div></div> <section class="tm-block tm-block tm-block_spacing-top" data-async-called="true"><header class="tm-block__header tm-block__header"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title">Работа</h2> </div> <!-- --></header> <div class="tm-block__body tm-block__body"><div class="tm-vacancies-block__item"><a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/unity_developer" target="_blank">
        Unity разработчик
      </a> <div class="tm-vacancies-block__vacancies-count">
        3
    вакансии
      </div></div><div class="tm-vacancies-block__item"><a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/rust_developer" target="_blank">
        Rust разработчик
      </a> <div class="tm-vacancies-block__vacancies-count">
        25
    вакансий
      </div></div><div class="tm-vacancies-block__item"><a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/game_developer" target="_blank">
        Разработчик игр
      </a> <div class="tm-vacancies-block__vacancies-count">
        79
    вакансий
      </div></div></div> <footer class="tm-block__footer"><a class="tm-block-extralink" href="https://career.habr.com/catalog">
      Все вакансии
    </a></footer></section></div></div></div></div></div> <div class="tm-page__sidebar"><!-- --></div></div></div></div></main> <!-- --></div> <!-- --> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><div class="tm-footer__title"><a class="tm-svg-icon__wrapper tm-footer__title-link router-link-active" href="/ru/"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a></div> <div class="tm-footer__social"><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="16" width="16"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <div class="v-portal" style="display:none;"></div> <button class="tm-footer__link"><svg class="tm-svg-img tm-footer__icon" height="16" width="16"><title>Язык</title> <use xlink:href="/img/megazord-v28.617e16ca..svg#lang"></use></svg>
        Настройка языка
      </button> <a class="tm-footer__link" href="/ru/feedback/">
        Техническая поддержка
      </a> <a class="tm-footer__link" href="/berserk-mode-nope">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2023, </span> <span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank">Habr</a></span></span></div></div></div></div> <!-- --> <!-- --></div> <div class="vue-portal-target"></div></div>





<noscript>
<div>
<img alt="" src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;"/>
</div>
</noscript>


</body>
</html>
